<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Reset Password</title>
    <link rel="stylesheet" href="css/loginstyle.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
    />
  </head>

  <body class="auth-page">
    <div class="tech-bg"></div>

    <div class="auth-card">
      <h2>Reset Password</h2>
      <p style="color: #aaa; font-size: 14px; margin-bottom: 20px">
        Enter your new password below
      </p>

      <div id="resetForm">
        <div class="form-group password-group">
          <input
            type="password"
            id="newPassword"
            placeholder="New Password (min 6 characters)"
            required
          />
          <span class="show-pass" data-target="newPassword">üëÅ</span>
        </div>

        <div class="form-group password-group">
          <input
            type="password"
            id="confirmPassword"
            placeholder="Confirm New Password"
            required
          />
          <span class="show-pass" data-target="confirmPassword">üëÅ</span>
        </div>

        <button class="submit-btn" id="resetBtn">Reset Password</button>
        <div class="loader" id="resetLoader"></div>
        <div class="message" id="resetMessage"></div>

        <div class="link-text">
          <a href="/login.html">Back to Login</a>
        </div>
      </div>
    </div>

    <script>
      /* =========================
           FLOATING TECH ICONS
        ========================= */
      const techIcons = [
        { icon: "fa-html5", glow: "glow-html" },
        { icon: "fa-css3-alt", glow: "glow-css" },
        { icon: "fa-js", glow: "glow-js" },
        { icon: "fa-react", glow: "glow-react" },
        { icon: "fa-node-js", glow: "glow-node" },
        { icon: "fa-python", glow: "glow-python" },
        { icon: "fa-github", glow: "glow-github" },
      ];

      const techLayer = document.querySelector(".tech-bg");
      const iconsOnScreen = [];

      function getIconCount() {
        const w = window.innerWidth;
        if (w >= 1440) return 28;
        if (w >= 1200) return 22;
        if (w >= 992) return 18;
        if (w >= 768) return 14;
        if (w >= 480) return 10;
        return 7;
      }

      function createIcons() {
        techLayer.innerHTML = "";
        iconsOnScreen.length = 0;

        const ICON_COUNT = getIconCount();

        for (let i = 0; i < ICON_COUNT; i++) {
          const data = techIcons[Math.floor(Math.random() * techIcons.length)];

          const el = document.createElement("i");
          el.className = `fa-brands ${data.icon} tech-icon ${data.glow}`;

          el.style.left = Math.random() * 100 + "vw";
          el.style.top = Math.random() * 100 + "vh";

          const baseSpeed = window.innerWidth < 768 ? 32 : 22;
          el.style.animationDuration = baseSpeed + Math.random() * 18 + "s";
          el.style.animationDelay = Math.random() * -20 + "s";

          techLayer.appendChild(el);
          iconsOnScreen.push(el);
        }
      }

      document.addEventListener("mousemove", (e) => {
        iconsOnScreen.forEach((icon) => {
          const rect = icon.getBoundingClientRect();
          const cx = rect.left + rect.width / 2;
          const cy = rect.top + rect.height / 2;

          const dist = Math.hypot(e.clientX - cx, e.clientY - cy);

          if (dist < 160) {
            icon.classList.add("active");
          } else {
            icon.classList.remove("active");
          }
        });
      });

      createIcons();

      let resizeTimer;
      window.addEventListener("resize", () => {
        clearTimeout(resizeTimer);
        resizeTimer = setTimeout(createIcons, 300);
      });

      /* =========================
           PASSWORD SHOW/HIDE
        ========================= */
      document.querySelectorAll(".show-pass").forEach((icon) => {
        icon.addEventListener("click", () => {
          const target = document.getElementById(icon.dataset.target);
          target.type = target.type === "password" ? "text" : "password";
        });
      });

      /* =========================
           RESET PASSWORD LOGIC
        ========================= */
      function showMessage(text, type) {
        const el = document.getElementById("resetMessage");
        el.textContent = text;
        el.className = `message ${type}`;
      }

      // Get token from URL
      const urlParams = new URLSearchParams(window.location.search);
      const token = urlParams.get("token");

      if (!token) {
        showMessage(
          "Invalid or missing reset token. Please request a new reset link.",
          "error"
        );
        document.getElementById("resetBtn").disabled = true;
      }

      // Reset password handler
      document
        .getElementById("resetBtn")
        .addEventListener("click", async () => {
          const newPassword = document
            .getElementById("newPassword")
            .value.trim();
          const confirmPassword = document
            .getElementById("confirmPassword")
            .value.trim();
          const loader = document.getElementById("resetLoader");
          const btn = document.getElementById("resetBtn");

          // Validation
          if (!newPassword || !confirmPassword) {
            showMessage("Please fill in all fields", "error");
            return;
          }

          if (newPassword.length < 6) {
            showMessage("Password must be at least 6 characters", "error");
            return;
          }

          if (newPassword !== confirmPassword) {
            showMessage("Passwords do not match", "error");
            return;
          }

          loader.style.display = "block";
          btn.disabled = true;
          showMessage("", "");

          try {
            const res = await fetch("/api/auth/reset", {
              method: "POST",
              credentials: "include",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ token, newPassword }),
            });

            const data = await res.json();
            loader.style.display = "none";
            btn.disabled = false;

            if (res.ok) {
              showMessage(
                data.message || "Password reset successful!",
                "success"
              );

              // Clear fields
              document.getElementById("newPassword").value = "";
              document.getElementById("confirmPassword").value = "";

              // Redirect to login after 2 seconds
              setTimeout(() => {
                window.location.href = "/login.html";
              }, 2000);
            } else {
              showMessage(
                data.message ||
                  "Failed to reset password. Link may be expired.",
                "error"
              );
            }
          } catch (err) {
            loader.style.display = "none";
            btn.disabled = false;
            showMessage(
              "Network error. Please check your connection and try again.",
              "error"
            );
            console.error("Reset password error:", err);
          }
        });

      // Enter key support
      document
        .getElementById("confirmPassword")
        .addEventListener("keypress", (e) => {
          if (e.key === "Enter") {
            document.getElementById("resetBtn").click();
          }
        });
    </script>
  </body>
</html>
